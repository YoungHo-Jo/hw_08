#include <misc.h>
#include "stm32f10x.h"
#include "stm32f10x_exti.h"
#include "stm32f10x_gpio.h"
#include "stm32f10x_rcc.h"
#include "stm32f10x_usart.h"

void Delay(volatile unsigned int time) {
   for (; time > 0; time--) {
   }
}


void SerialSendChar(uint8_t c)
{
  USART_SendData(USART1, c);
  while (USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET);
}

void SerialSendChar2(uint8_t c)
{
  USART_SendData(USART2, c);
  while (USART_GetFlagStatus(USART2, USART_FLAG_TXE) == RESET);
}

void USART1_IRQHandler(void) { // 컴퓨터->보드->블투스
	if (USART_GetITStatus(USART1, USART_IT_RXNE) != RESET) {
		uint16_t get;
		get = USART_ReceiveData(USART1);

		//블루투스로 보내는 코드 작성
		SerialSendChar2(get);

		USART_ClearITPendingBit(USART1, USART_IT_RXNE);
	}
	USART_ClearITPendingBit(USART1, USART_IT_RXNE);
}

void USART2_IRQHandler(void) {  //블투 ->보드 -> 컴퓨터
	if (USART_GetITStatus(USART2, USART_IT_RXNE) != RESET) {
		uint16_t get;
		get = USART_ReceiveData(USART2);

		SerialSendChar(get);
		USART_ClearITPendingBit(USART2, USART_IT_RXNE);
	}
	USART_ClearITPendingBit(USART2, USART_IT_RXNE);
}




void EXTI15_10_IRQHandler(void) {
	if (EXTI_GetFlagStatus(EXTI_Line11) != RESET) {
		GPIO_SetBits(GPIOD, GPIO_Pin_2);
		Delay(500000);
		GPIO_ResetBits(GPIOD, GPIO_Pin_2);
		Delay(500000);
		GPIO_SetBits(GPIOD, GPIO_Pin_3);
		Delay(500000);
		GPIO_ResetBits(GPIOD, GPIO_Pin_3);
		Delay(500000);
		GPIO_SetBits(GPIOD, GPIO_Pin_4);
		Delay(500000);
		GPIO_ResetBits(GPIOD, GPIO_Pin_4);
		Delay(500000);
		GPIO_SetBits(GPIOD, GPIO_Pin_7);
		Delay(500000);
		GPIO_ResetBits(GPIOD, GPIO_Pin_7);
		Delay(500000);
		EXTI_ClearITPendingBit(EXTI_Line11); // 요기
	}
	else if (EXTI_GetFlagStatus(EXTI_Line12) != RESET) {
		GPIO_SetBits(GPIOD, GPIO_Pin_2);
		GPIO_SetBits(GPIOD, GPIO_Pin_3);
		GPIO_SetBits(GPIOD, GPIO_Pin_4);
		GPIO_SetBits(GPIOD, GPIO_Pin_7);
		Delay(500000);
		GPIO_ResetBits(GPIOD, GPIO_Pin_2);
		GPIO_ResetBits(GPIOD, GPIO_Pin_3);
		GPIO_ResetBits(GPIOD, GPIO_Pin_4);
		GPIO_ResetBits(GPIOD, GPIO_Pin_7);
		SerialSendChar('T');
		SerialSendChar('H');
		SerialSendChar('U');
		SerialSendChar('_');
		SerialSendChar('t');
		SerialSendChar('e');
		SerialSendChar('a');
		SerialSendChar('m');
		SerialSendChar('8');
		SerialSendChar('_');
		SerialSendChar('U');
		SerialSendChar('A');
		SerialSendChar('R');
		SerialSendChar('T');
		SerialSendChar('_');
		SerialSendChar('T');
		SerialSendChar('E');
		SerialSendChar('S');
		SerialSendChar('T');
		EXTI_ClearITPendingBit(EXTI_Line12); // 요기
	}
}

int main() {
	GPIO_InitTypeDef GPIO_A_RX,GPIO_A_TX;
	USART_InitTypeDef usart,usart2;
	EXTI_InitTypeDef exti_usart_rx, exti_gpiod_11, exti_gpiod_12;
	NVIC_InitTypeDef nvic_usart_rx,nvic_usart_rx2, nvic_gpiod_11, nvic_gpiod_12;

	RCC_DeInit();
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA | RCC_APB2Periph_USART1 | RCC_APB2Periph_AFIO, ENABLE);
							//USART1 TX RX          //USART1			//External Interrupt
	RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART2, ENABLE);
							//USART2

	//USART1 TX(PA9)
	GPIO_A_TX.GPIO_Pin = GPIO_Pin_9;
	GPIO_A_TX.GPIO_Mode = GPIO_Mode_AF_PP;	//Alternate Function push_pull (1000)
	GPIO_A_TX.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOA, &GPIO_A_TX);

	//USART1 RX(PA10)
	GPIO_A_RX.GPIO_Pin = GPIO_Pin_10;
	GPIO_A_RX.GPIO_Mode = GPIO_Mode_IN_FLOATING;	//Input
	GPIO_Init(GPIOA, &GPIO_A_RX);

	//USART2 TX(PA2)
	GPIO_A_TX.GPIO_Pin = GPIO_Pin_2;
	GPIO_A_TX.GPIO_Mode = GPIO_Mode_AF_PP;	//Alternate Function push_pull (1000)
	GPIO_A_TX.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_Init(GPIOA, &GPIO_A_TX);

	//USART2 RX(PA3)
	GPIO_A_RX.GPIO_Pin = GPIO_Pin_3;
	GPIO_A_RX.GPIO_Mode = GPIO_Mode_IN_FLOATING;	//Input
	GPIO_Init(GPIOA, &GPIO_A_RX);

	//Interrupt
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOD, GPIO_PinSource11); // Button(PD11)
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOD, GPIO_PinSource12); // Button(PD12)
	GPIO_EXTILineConfig(GPIO_PortSourceGPIOA, GPIO_PinSource10); // USART_RX(PA10)

	//Init Usart
	usart.USART_BaudRate = 9600;
	usart.USART_WordLength = USART_WordLength_9b;
	usart.USART_Mode = USART_Mode_Tx | USART_Mode_Rx ;
	usart.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
	usart.USART_Parity = USART_Parity_Even;
	usart.USART_StopBits = USART_StopBits_1;
	USART_Init(USART1, &usart);
	USART_Cmd(USART1, ENABLE);

	//Init Usart2
	usart2.USART_BaudRate = 9600;
	usart2.USART_WordLength = USART_WordLength_9b;
	usart2.USART_Mode = USART_Mode_Tx | USART_Mode_Rx ;
	usart2.USART_HardwareFlowControl = USART_HardwareFlowControl_None;
	usart2.USART_Parity = USART_Parity_Even;
	usart2.USART_StopBits = USART_StopBits_1;
	USART_Init(USART2, &usart2);
	USART_Cmd(USART2, ENABLE);

	//Interrupt Connection
	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);
	USART_ITConfig(USART2, USART_IT_RXNE, ENABLE);


	//Open External Interrupt Line10 == RX(PA10)
	exti_usart_rx.EXTI_Line = EXTI_Line10;
	exti_usart_rx.EXTI_LineCmd = ENABLE;
	exti_usart_rx.EXTI_Mode = EXTI_Mode_Interrupt;
	exti_usart_rx.EXTI_Trigger = EXTI_Trigger_Falling;  //start bit == 0 1->0
	EXTI_Init(&exti_usart_rx);

	exti_gpiod_11.EXTI_Line = EXTI_Line11;	// BTN
	exti_gpiod_11.EXTI_LineCmd = ENABLE;
	exti_gpiod_11.EXTI_Mode = EXTI_Mode_Interrupt;
	exti_gpiod_11.EXTI_Trigger = EXTI_Trigger_Rising;
	EXTI_Init(&exti_gpiod_11);

	exti_gpiod_12.EXTI_Line = EXTI_Line12;	// BTN
	exti_gpiod_12.EXTI_LineCmd = ENABLE;
	exti_gpiod_12.EXTI_Mode = EXTI_Mode_Interrupt;
	exti_gpiod_12.EXTI_Trigger = EXTI_Trigger_Rising;
	EXTI_Init(&exti_gpiod_12);

	//Priority
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
	nvic_usart_rx.NVIC_IRQChannel = USART1_IRQn;		//USART1 global Interrupt
	nvic_usart_rx.NVIC_IRQChannelCmd = ENABLE;
	nvic_usart_rx.NVIC_IRQChannelPreemptionPriority = 0;
	nvic_usart_rx.NVIC_IRQChannelSubPriority = 0;
	NVIC_Init(&nvic_usart_rx);

	nvic_usart_rx2.NVIC_IRQChannel = USART2_IRQn;
	nvic_usart_rx2.NVIC_IRQChannelCmd = ENABLE;
	nvic_usart_rx2.NVIC_IRQChannelPreemptionPriority = 0;
	nvic_usart_rx2.NVIC_IRQChannelSubPriority = 0;
	NVIC_Init(&nvic_usart_rx2);

	while (1) {

	}
}
